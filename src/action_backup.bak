


# regex patterns
PATTERN_COMMENT='^[[:blank:]]*#'
PATTERN_SECTION='^[[:blank:]]*\[(.+)\][[:blank:]]$'
# first blanks, then key (letters/numbers), then spaces, then =, then blanks, then value (any characters, but ending in non-blank character), then blanks
PATTERN_KEY_VALUE='^[[:blank:]]*([[:alnum:]]+)[[:blank:]]*=[[:blank:]]*(.+[^[:blank:]])[[:blank:]]*$'

# receives single service as input
# reads backups.cfg and runs every backup command
action_backup() {
    str=":"
    while true; do
        IFS='=' read key value
        if (( $? > 0 )); then is_done="true"; else is_done=; fi

        key="$(echo "$key" | trim)"
        if contains_space "$key"; then echo "ERROR: key '$key' contains whitespace"; return 1; fi
        value="$(echo "$value" | trim)"

        if [[ $key == \[*] || $is_done ]]; then
            # found section
            section="$key"
            str+='; eval "$command"'
            # execute in new shell with clean env
            env -i SERVICE="$1" bash -c "$str"
            # reset
            str=":"
        elif [[ $value ]]; then
            # found key value pair
            str+="; declare '$key'='$value'"
        fi

        if [[ $is_done ]]; then break; fi
    done < "./backups.cfg"
}
